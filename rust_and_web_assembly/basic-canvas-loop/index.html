<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <style>
      canvas {
        background-color: white;
        width: 100%;
        height: 100%;
        display: block;
      }
    </style>
  </head>
  <body>
    <!-- Include the JS generated by `wasm-pack build` -->
    <script src='pkg/basic_canvas_loop.js'></script>

    <script type=module>
      // Like with the `--target web` output the exports are immediately
      // available but they won't work until we initialize the module. Unlike
      // `--target web`, however, the globals are all stored on a
      // `wasm_bindgen` global. The global itself is the initialization
      // function and then the properties of the global are all the exported
      // functions.
      //
      // Note that the name `wasm_bindgen` can be configured with the
      // `--no-modules-global` CLI flag
      const { Renderer } = wasm_bindgen;

      async function run() {
        await wasm_bindgen('./pkg/basic_canvas_loop_bg.wasm');
      }

      function loaded() {
        const renderer = Renderer.new("render-canvas", new Date().getTime());

        const renderLoop = () => {
          const t1 = new Date().getTime();
          renderer.render(t1);
          const t2 = new Date().getTime();
          
          // aim for about at little more than 60 frames per second (1000/60=16.6...)
          const timeout = 16 - (t2 - t1);
          // processing is taking longer than we can fit in 60 frames per second so draw immediately
          if (timeout <= 0) {
            requestAnimationFrame(renderLoop);
          // we have some spare time, no need to render
          } else {
            setTimeout(() => {
            requestAnimationFrame(renderLoop);
            }, timeout);
          }
          
        };

        // initial render
        requestAnimationFrame(renderLoop);
      }

      // set canvas to window size
      const canvas = document.getElementById("render-canvas");
      canvas.width  = window.innerWidth;
      canvas.height = window.innerHeight;

      run().then(loaded);
    </script>
    <canvas id="render-canvas"></canvas> 
  </body>
</html>
